关于ADB的实现说明

I. 概览:

Android ADB使用于:

- 跟踪连接到给定主机开发者机器或在其上运行的所有 Android 设备和模拟器实例

- 为客户端（命令行用户或 DDMS 等辅助程序）的利益实施各种控制命令（例如“adb shell”、“adb pull”等）。 这些命令在 ADB 中称为“服务”。

总的来说，一切都通过以下组件进行：

  1. ADB服务

    这是在主机上运行的后台进程。 其目的是感应 USB 端口以了解设备何时连接/移除，以及模拟器实例何时启动/停止。
    因此，它维护一个“已连接设备”列表，并为每个设备分配一个“状态”：离线(OFFLINE)、引导加载器(BOOTLOADER)、恢复(RECOVERY)或在线(ONLINE)（更多内容见下文）。
    ADB 服务器实际上是一个巨大的多路复用循环，其目的是协调客户端、服务和设备之间的数据交换（实际上是数据包）。


  2. ADB 守护进程 (adbd)

    “adbd”程序在 Android 设备或模拟系统中作为后台进程运行。 它的目的是连接到 ADB 服务器（通过 USB 连接设备，通过 TCP 连接模拟器）并为运行在主机上的客户端提供一些服务。
    当 ADB 服务器成功连接到其中的 adbd 程序时，ADB 服务器认为该设备处于在线状态。 否则，设备处于离线状态，这意味着 ADB 服务器检测到新设备/模拟器，但无法连接到 adbd 守护程序。
    引导加载器(BOOTLOADER)和恢复(RECOVERY) 状态对应于设备处于引导加载程序或恢复模式时的备用状态。

  3. ADB 命令行客户端

    'adb' 命令行程序用于从 shell 或脚本运行 adb 命令。 它首先尝试在主机上找到 ADB 服务器，如果找不到，它将自动启动一个。
    然后，客户端将其服务请求发送到 ADB 服务器。
    目前，服务器和客户端都使用一个“adb”二进制文件。 这使得分发和启动服务器更容易。


  4. 服务

    客户可以与之交谈的服务基本上有两种:

    Host Services【主机服务】:
      这些服务在 ADB 服务器中运行，因此根本不需要与设备通信。 一个典型的例子是“adb devices”，它用于返回当前已知设备的列表及其状态。 不过，它们是其他一些服务。

    Local Services【本地服务】:
      这些服务要么在 adbd 守护进程中运行，要么由它在设备上启动。 ADB 服务器用于在客户端和运行在 adbd 中的服务之间多路复用流。 在这种情况下，它的作用是启动连接，然后是数据的传递。


II. 协议细节:

  1. 客户端 <-> 服务端 交互协议:
    这详细说明了 ADB 客户端和 ADB 服务器本身之间使用的协议。 ADB 服务器侦听 TCP:localhost:5037。

    客户端使用以下格式发送请求:

        1. 给出有效载荷的长度,一个4字节的十六进制字符串
        2. 紧随其后的是有效荷载本身.

    例如，要向 ADB 服务器查询其内部版本号，客户端将执行以下操作:

        1. 连接到地址 tcp:localhost:5037
        2. 发送字符串 "000Chost:version" 到对应的套接字(socket)

    'host:' 前缀用于指示请求是针对服务器本身的（我们稍后会讨论其他类型的请求）。 内容长度以 ASCII 编码方式计算以便于调试。
    服务器应使用以下之一回答请求：

        1. 如果成功,回复是4个字节的字符串"OKEY"

        2. 如果失败，回复是4个字节的字符串"FAIL",随后的是4字节长度的十六进制数据，后面是一个描述失败原因的字符串

    注意，在 OKAY 之后连接仍然有效，这允许客户端发出其他请求。 但在某些情况下，OKAY 甚至会改变连接的状态。
    例如，'host:transport:<serialnumber>' 请求的情况，其中 '<serialnumber>' 用于标识给定的设备/模拟器； 在“OKAY”回答之后，客户端发出的所有进一步请求将直接转到相应的 adbd 守护进程。

    SERVICES.TXT 文件列出了 ADB 当前实现的所有服务。


  2. 传输方式:

    ADB 传输模拟 ADB 服务器和一个设备或模拟器之间的连接。 目前有两种运输方式：

       - USB 传输，通过 USB 用于物理设备
       - 本地传输，用于在主机上运行的模拟器，通过 TCP 连接到服务器

    理论上，应该可以编写一个本地传输来代理 ADB 服务器和连接到/运行在另一台机器上的设备/模拟器之间的连接。 不过，这还没有完成
    每个传输都可以在客户端和它们指向的设备/模拟器之间传输一个或多个多路复用流。 ADB 服务器必须正确处理意外的传输断开连接（例如，当设备物理拔出时）。

